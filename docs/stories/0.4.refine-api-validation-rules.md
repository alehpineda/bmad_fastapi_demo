# Story 0.4: Refine API Validation Rules

## Status
Done

## Story
**As a** user of the API,
**I want** the system to reject invalid or duplicate data submissions,
**so that** the integrity of the data is protected and the API behaves in a predictable way.

## Acceptance Criteria
1.  When a `POST /pokemon` request is made with a missing `name` or `type`, the API must return a `422 Unprocessable Entity` status code.
2.  When a `POST /pokemon` request is made with a `name` that is not a string or a `type` that is not a string, the API must return a `422 Unprocessable Entity` status code.
3.  When a `POST /pokemon` request is made for a Pokémon whose `name` already exists in the system (case-insensitive), the API must return a `409 Conflict` status code.
4.  The JSON response body for any validation error (422 or 409) must contain a `detail` field with a clear, human-readable error message explaining the specific issue.

## Tasks / Subtasks
*   **[x] Task 1: Implement Duplicate Name Validation (AC: #3)**
    *   [x] In the `PokemonService`, before creating a new Pokémon, add logic to check if a Pokémon with the same name already exists in the `PokemonRepository`.
    *   [x] The check must be case-insensitive.
    *   [x] If a duplicate is found, raise a custom exception (e.g., `DuplicatePokemonError`).

*   **[x] Task 2: Create Custom Exception Handler (AC: #3, #4)**
    *   [x] Implement a custom exception handler in the main FastAPI application.
    *   [x] This handler will catch the `DuplicatePokemonError` and return a JSON response with a `409 Conflict` status code and a clear error message in the `detail` field.

*   **[x] Task 3: Write Unit Tests for Validation Logic (AC: #1, #2, #3, #4)**
    *   [x] In `tests/test_api/`, write tests that attempt to create Pokémon with:
        *   [x] Missing `name` field.
        *   [x] Missing `type` field.
        *   [x] `name` field with a non-string value.
        *   [x] A `name` that already exists.
    *   [x] Assert that the API returns the correct status codes (422 or 409) and error messages for each case.

## Dev Notes
This story focuses on adding business rule validation on top of the default validation provided by FastAPI and Pydantic.

*   **Leverage Pydantic:** Acceptance Criteria #1 and #2 (checking for missing or mistyped fields) are handled automatically by FastAPI. As long as the Pydantic model (`Pokemon` in `app/models/pokemon_model.py`) is correctly defined, no extra code is needed for this. The developer should focus on the custom logic.

*   **Business Logic in Service Layer:** The check for duplicate names (AC #3) is a business rule. This logic should reside in the `PokemonService`, not in the API endpoint handler. The service should query the repository, and if a duplicate is found, it should raise a custom exception.

*   **Custom Exception Handling:** To return a `409 Conflict` status, the developer should:
    1.  Define a custom exception class, for example, `DuplicatePokemonError`.
    2.  Raise this exception from the `PokemonService`.
    3.  Create an exception handler in `main.py` using the `@app.exception_handler()` decorator to catch `DuplicatePokemonError` and return the appropriate `JSONResponse` with the 409 status code. This keeps the API layer clean and separates concerns.

*   **Testing:** Unit tests are critical for this story.
    *   Tests should verify that posting invalid data structures results in a `422` error.
    *   A specific test must be written to pre-load a Pokémon into the (mocked) repository, then attempt to add another with the same name (case-insensitively), and assert that a `409` error is returned.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-25 | 0.1 | Initial draft | Bob (Scrum Master) |
| 2025-08-25 | 1.0 | Implemented validation logic and unit tests. | James (Developer) |
